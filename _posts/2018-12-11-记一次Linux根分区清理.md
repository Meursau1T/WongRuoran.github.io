---
layout: post
title:  "从删除大文件到btrfs磁盘管理"
date:   2018-12-11 14:54:01
categories: [Linux]
---

# 删除大文件
在使用一段操作系统后，可能会遇到根分区空间不足的情况，处理思路如下：
1. `df -h`  
确认根分区占用率  

2. `sudo du -lh --max-depth=1 /`  
查看每个文件夹的大小  

3. 进入大文件夹，重复这三个步骤。

**注意**：  
- 最好只对var和tmp这两个文件夹进行操作，因为里面一般是安装包日志缓存一类的可以删除的文件。另外，/opt目录下如果有不需要的软件，可以直接rm -rf而不会有副作用，这个目录下的软件都是可选(OPTional)的。  
- 因为linux下文件被删除后正在使用被删除文件的应用还会继续工作，因此被删除的文件所在的空间并不会被释放，需要重启电脑或者kill掉占用的进程来释放空间。

# btrfs磁盘管理
因为我的根分区格式时btrfs，所以我先看的是快照，用`sudo du -lh --max-depth=1 /.snapshots`看了一眼，吓了一跳，加起来足足112G。然而这不现实，我根分区一共才40G。经过了解发现，du得到的快照大小是不准确的，对于btrfs格式的文件系统，有一套特殊的操作方式。

首先，用  
`btrfs filesystem usage /`  
检查根分区的使用率  
`btrfs filesystem defragment -r /`  
整理磁盘碎片  
`sudo btrfs filesystem defragment -r -v -czstd /`  
压缩根分区所有文件，在某些特定的场景下（比如单线程、重文件I/O）还提高了性能，尽管在其他的场景下（比如多线程和/或具有大文件 I/O 的 CPU 密集型任务）显著得影响了性能。  
**不要在更新内核后重新启动前使用这个功能！内核会坏掉！**
